<!--
  Ask Mark Chat Widget - Standalone HTML Version
  
  This is a self-contained chat widget that can be embedded on any website.
  Just include this HTML file or copy the code into your page.
  
  Usage:
  1. Set your API URL in the config section below
  2. Add this script to your page, or embed the entire widget
  3. Add a container div: <div id="ask-mark-container"></div>
-->

<div id="ask-mark-widget">
  <!-- Widget HTML is generated by JavaScript below -->
</div>

<style>
  /* Ask Mark Chat Widget Styles - Brave & Boundless Brand */
  
  #ask-mark-widget {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    max-width: 600px;
    margin: 0 auto;
    height: 600px;
    display: flex;
    flex-direction: column;
    border: 3px solid #1a1a1a;
    background-color: #faf8f5;
    box-shadow: 8px 8px 0 #1a1a1a;
  }

  /* Header */
  .am-header {
    background-color: #1a1a1a;
    color: #faf8f5;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .am-header-icon {
    width: 40px;
    height: 40px;
    background-color: #e63946;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
  }

  .am-header-title {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .am-header-subtitle {
    margin: 2px 0 0 0;
    font-size: 12px;
    opacity: 0.8;
  }

  /* Messages container */
  .am-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Welcome screen */
  .am-welcome {
    text-align: center;
    padding: 20px;
  }

  .am-welcome-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #1a1a1a;
  }

  .am-welcome-text {
    font-size: 14px;
    color: #4a4a4a;
    line-height: 1.5;
    margin-bottom: 20px;
  }

  .am-starters {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .am-starter-btn {
    background-color: #fff;
    border: 2px solid #1a1a1a;
    padding: 12px 16px;
    font-size: 14px;
    text-align: left;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .am-starter-btn:hover {
    background-color: #1a1a1a;
    color: #faf8f5;
  }

  /* Message bubbles */
  .am-message-row {
    display: flex;
    gap: 12px;
    max-width: 90%;
  }

  .am-message-row.user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .am-message-row.assistant {
    align-self: flex-start;
  }

  .am-avatar {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    flex-shrink: 0;
  }

  .am-avatar.user {
    background-color: #f4a261;
    color: #1a1a1a;
  }

  .am-avatar.assistant {
    background-color: #e63946;
    color: #faf8f5;
  }

  .am-bubble {
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.6;
  }

  .am-bubble.user {
    background-color: #1a1a1a;
    color: #faf8f5;
  }

  .am-bubble.assistant {
    background-color: #fff;
    border: 2px solid #1a1a1a;
  }

  /* Typing indicator */
  .am-typing {
    display: flex;
    gap: 4px;
    padding: 8px 0;
  }

  .am-typing-dot {
    width: 8px;
    height: 8px;
    background-color: #1a1a1a;
    border-radius: 50%;
    animation: am-pulse 1.4s infinite ease-in-out;
  }

  .am-typing-dot:nth-child(1) { animation-delay: 0s; }
  .am-typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .am-typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes am-pulse {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Input area */
  .am-input-container {
    padding: 16px 20px;
    border-top: 3px solid #1a1a1a;
    background-color: #fff;
  }

  .am-input-wrapper {
    display: flex;
    gap: 12px;
  }

  .am-input {
    flex: 1;
    padding: 12px 16px;
    font-size: 14px;
    border: 2px solid #1a1a1a;
    outline: none;
    font-family: inherit;
  }

  .am-input:focus {
    border-color: #e63946;
  }

  .am-send-btn {
    background-color: #e63946;
    color: #faf8f5;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .am-send-btn:hover:not(:disabled) {
    background-color: #c1121f;
  }

  .am-send-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  /* Email prompt */
  .am-email-prompt {
    background-color: #fcf3cf;
    border: 2px solid #f4a261;
    padding: 16px;
    margin: 0 20px 16px 20px;
  }

  .am-email-prompt p {
    font-size: 14px;
    margin: 0 0 12px 0;
    color: #1a1a1a;
  }

  .am-email-form {
    display: flex;
    gap: 8px;
  }

  .am-email-input {
    flex: 1;
    padding: 10px 12px;
    font-size: 14px;
    border: 2px solid #1a1a1a;
    font-family: inherit;
  }

  .am-email-btn {
    background-color: #1a1a1a;
    color: #faf8f5;
    border: none;
    padding: 10px 16px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    font-family: inherit;
  }

  .am-dismiss-btn {
    background: none;
    border: none;
    font-size: 12px;
    color: #666;
    cursor: pointer;
    margin-top: 8px;
    font-family: inherit;
  }

  /* Status messages */
  .am-success {
    background-color: #d4edda;
    border: 2px solid #28a745;
    padding: 12px 16px;
    margin: 0 20px 16px 20px;
    font-size: 14px;
    color: #155724;
  }

  .am-error {
    background-color: #f8d7da;
    border: 2px solid #dc3545;
    padding: 12px 16px;
    font-size: 14px;
    color: #721c24;
    margin: 8px 0;
  }

  /* Responsive */
  @media (max-width: 640px) {
    #ask-mark-widget {
      height: 100vh;
      max-width: 100%;
      border: none;
      box-shadow: none;
    }
  }
</style>

<script>
(function() {
  // ============================================
  // CONFIGURATION - Set your API URL here
  // ============================================
  const CONFIG = {
    apiUrl: 'http://localhost:3001', // Change this to your backend URL
  };

  // Starter questions
  const STARTER_QUESTIONS = [
    "I'm stuck in a job I hateâ€”what should I do?",
    "How do I have a hard conversation I've been avoiding?",
    "My teenager won't listen to me. Help.",
    "I feel like I've wasted years of my life. Is it too late?",
    "How do I know if my relationship is worth fighting for?",
  ];

  // State
  let messages = [];
  let conversationId = null;
  let isLoading = false;
  let showEmailPrompt = false;
  let emailDismissed = false;
  let emailSubmitted = false;

  // Initialize widget
  function init() {
    render();
    attachEventListeners();
  }

  // Render the widget
  function render() {
    const widget = document.getElementById('ask-mark-widget');
    
    let messagesHtml = '';
    
    if (messages.length === 0) {
      // Welcome screen
      messagesHtml = `
        <div class="am-welcome">
          <div class="am-welcome-title">What's on your mind?</div>
          <p class="am-welcome-text">
            Get straight-talk advice on career, relationships, parenting, faith, 
            and breaking the patterns that hold you back. No bullshit, no sugarcoating.
          </p>
          <div class="am-starters">
            ${STARTER_QUESTIONS.map((q, i) => `
              <button class="am-starter-btn" data-question="${i}">${q}</button>
            `).join('')}
          </div>
        </div>
      `;
    } else {
      // Messages
      messagesHtml = messages.map(msg => `
        <div class="am-message-row ${msg.role}">
          <div class="am-avatar ${msg.role}">${msg.role === 'user' ? 'Y' : 'M'}</div>
          <div class="am-bubble ${msg.role}">${formatMessage(msg.content)}</div>
        </div>
      `).join('');

      // Loading indicator
      if (isLoading) {
        messagesHtml += `
          <div class="am-message-row assistant">
            <div class="am-avatar assistant">M</div>
            <div class="am-bubble assistant">
              <div class="am-typing">
                <div class="am-typing-dot"></div>
                <div class="am-typing-dot"></div>
                <div class="am-typing-dot"></div>
              </div>
            </div>
          </div>
        `;
      }
    }

    // Email prompt
    let emailHtml = '';
    if (showEmailPrompt && !emailDismissed && !emailSubmitted) {
      emailHtml = `
        <div class="am-email-prompt">
          <p>Finding this helpful? Get notified when <em>Brave & Boundless</em> launches.</p>
          <form class="am-email-form" id="am-email-form">
            <input type="email" class="am-email-input" id="am-email-input" placeholder="Your email" required>
            <button type="submit" class="am-email-btn">Notify Me</button>
          </form>
          <button class="am-dismiss-btn" id="am-dismiss-btn">No thanks</button>
        </div>
      `;
    } else if (emailSubmitted) {
      emailHtml = `<div class="am-success">You're on the list. Watch your inbox.</div>`;
    }

    widget.innerHTML = `
      <div class="am-header">
        <div class="am-header-icon">M</div>
        <div>
          <h1 class="am-header-title">Ask Mark</h1>
          <p class="am-header-subtitle">Advice from Brave & Boundless</p>
        </div>
      </div>
      
      <div class="am-messages" id="am-messages">
        ${messagesHtml}
      </div>
      
      ${emailHtml}
      
      <div class="am-input-container">
        <form class="am-input-wrapper" id="am-chat-form">
          <input 
            type="text" 
            class="am-input" 
            id="am-input" 
            placeholder="Ask anything..."
            ${isLoading ? 'disabled' : ''}
          >
          <button 
            type="submit" 
            class="am-send-btn" 
            id="am-send-btn"
            ${isLoading ? 'disabled' : ''}
          >Send</button>
        </form>
      </div>
    `;

    // Scroll to bottom
    const messagesContainer = document.getElementById('am-messages');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Re-attach event listeners after render
    attachEventListeners();
  }

  // Format message (handle **bold** text)
  function formatMessage(text) {
    // Escape HTML first
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // Convert **bold** to <strong>
    text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Convert newlines to breaks
    text = text.replace(/\n/g, '<br>');
    return text;
  }

  // Attach event listeners
  function attachEventListeners() {
    // Chat form
    const chatForm = document.getElementById('am-chat-form');
    if (chatForm) {
      chatForm.onsubmit = function(e) {
        e.preventDefault();
        const input = document.getElementById('am-input');
        if (input && input.value.trim()) {
          sendMessage(input.value.trim());
        }
      };
    }

    // Starter buttons
    document.querySelectorAll('.am-starter-btn').forEach(btn => {
      btn.onclick = function() {
        const index = parseInt(this.getAttribute('data-question'));
        sendMessage(STARTER_QUESTIONS[index]);
      };
    });

    // Email form
    const emailForm = document.getElementById('am-email-form');
    if (emailForm) {
      emailForm.onsubmit = function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('am-email-input');
        if (emailInput && emailInput.value.trim()) {
          submitEmail(emailInput.value.trim());
        }
      };
    }

    // Dismiss button
    const dismissBtn = document.getElementById('am-dismiss-btn');
    if (dismissBtn) {
      dismissBtn.onclick = function() {
        showEmailPrompt = false;
        emailDismissed = true;
        render();
      };
    }
  }

  // Send message to API
  async function sendMessage(text) {
    if (isLoading) return;

    messages.push({ role: 'user', content: text });
    isLoading = true;
    render();

    try {
      const response = await fetch(`${CONFIG.apiUrl}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages,
          conversationId: conversationId
        })
      });

      if (!response.ok) {
        throw new Error('Failed to get response');
      }

      const data = await response.json();
      
      messages.push({ role: 'assistant', content: data.message });
      conversationId = data.conversationId;
      
      if (data.shouldPromptEmail && !emailDismissed && !emailSubmitted) {
        showEmailPrompt = true;
      }

    } catch (error) {
      console.error('Chat error:', error);
      messages.push({ 
        role: 'assistant', 
        content: 'Sorry, something went wrong. Please try again.' 
      });
    } finally {
      isLoading = false;
      render();
      
      // Focus input
      const input = document.getElementById('am-input');
      if (input) input.focus();
    }
  }

  // Submit email
  async function submitEmail(email) {
    try {
      const response = await fetch(`${CONFIG.apiUrl}/api/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, conversationId })
      });

      if (response.ok) {
        emailSubmitted = true;
        showEmailPrompt = false;
        render();
      }
    } catch (error) {
      console.error('Email submit error:', error);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
